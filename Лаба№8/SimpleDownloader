package org.example;

import java.io.*;
import java.net.*;

/**
 * –ü–†–û–°–¢–û–ô –ó–ê–ì–†–£–ó–ß–ò–ö –§–ê–ô–õ–û–í - –ö–û–ù–°–û–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø
 * –≠—Ç–æ—Ç –∫–ª–∞—Å—Å —Å–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É URL
 *
 * –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
 * 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª
 * 2. –ò–∑–º–µ–Ω–∏—Ç–µ URL –∏ –ø—É—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
 * 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞
 */
public class SimpleDownloader {

    public static void main(String[] args) {
        System.out.println("=== –ó–ê–ü–£–°–ö –ü–†–û–ì–†–ê–ú–ú–´ –î–õ–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –§–ê–ô–õ–û–í ===");
        System.out.println();

        // –¢–µ—Å—Ç–æ–≤—ã–π –Ω–µ–±–æ–ª—å—à–æ–π —Ñ–∞–π–ª
        String fileUrl = "https://www.learningcontainer.com/wp-content/uploads/2020/04/sample-text-file.txt";

        // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞:
        // String fileUrl = "https://www.gravatar.com/avatar/205e460b479e2e5b48aec07710c08d50?s=200";

        String savePath = "downloaded_file.txt"; // –°–æ—Ö—Ä–∞–Ω–∏—Ç –≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞

        try {
            System.out.println("üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ...");
            System.out.println("üì• URL: " + fileUrl);
            System.out.println("üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫: " + savePath);
            System.out.println();

            // –®–ê–ì 3: –°–ö–ê–ß–ò–í–ê–ï–ú –§–ê–ô–õ
            downloadFile(fileUrl, savePath);

            System.out.println();
            System.out.println("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!");
            System.out.println("üìÅ –§–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è: " + new File(savePath).getAbsolutePath());

        } catch (Exception e) {
            System.err.println("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏: " + e.getMessage());
            System.out.println("üîß –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:");
            System.out.println("   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ");
            System.out.println("   2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π");
            System.out.println("   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –ø–∞–ø–∫—É");
        }
    }

    /**
     * –û–°–ù–û–í–ù–û–ô –ú–ï–¢–û–î –î–õ–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –§–ê–ô–õ–ê
     * @param urlString - –∞–¥—Ä–µ—Å —Ñ–∞–π–ª–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
     * @param filename - –∫—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
     */
    public static void downloadFile(String urlString, String filename) throws IOException {
        System.out.println("‚è≥ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");

        // 1. –û–¢–ö–†–´–í–ê–ï–ú –°–û–ï–î–ò–ù–ï–ù–ò–ï –° –°–ï–†–í–ï–†–û–ú
        URL url = new URL(urlString);
        HttpURLConnection connection = (HttpURLConnection) url.openConnection();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        connection.setRequestMethod("GET");
        connection.setConnectTimeout(10000); // 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        connection.setReadTimeout(30000);    // 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ —á—Ç–µ–Ω–∏–µ

        System.out.println("üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É...");

        // 2. –ü–†–û–í–ï–†–Ø–ï–ú –û–¢–í–ï–¢ –°–ï–†–í–ï–†–ê
        int responseCode = connection.getResponseCode();
        System.out.println("üì° –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + responseCode);

        if (responseCode != HttpURLConnection.HTTP_OK) {
            throw new IOException("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: " + responseCode);
        }

        // 3. –£–ó–ù–ê–ï–ú –†–ê–ó–ú–ï–† –§–ê–ô–õ–ê
        long fileSize = connection.getContentLengthLong();
        System.out.println("üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: " + formatFileSize(fileSize));
        System.out.println();

        // 4. –°–û–ó–î–ê–ï–ú –ü–û–¢–û–ö–ò –î–õ–Ø –ß–¢–ï–ù–ò–Ø –ò –ó–ê–ü–ò–°–ò
        try (BufferedInputStream inputStream = new BufferedInputStream(connection.getInputStream());
             FileOutputStream outputStream = new FileOutputStream(filename)) {

            byte[] buffer = new byte[4096]; // –ë—É—Ñ–µ—Ä 4KB
            int bytesRead;
            long totalBytesRead = 0;
            int percentComplete = 0;

            System.out.println("üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å...");

            // 5. –ß–ò–¢–ê–ï–ú –î–ê–ù–ù–´–ï –ò –ó–ê–ü–ò–°–´–í–ê–ï–ú –í –§–ê–ô–õ
            while ((bytesRead = inputStream.read(buffer)) != -1) {
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª
                outputStream.write(buffer, 0, bytesRead);
                totalBytesRead += bytesRead;

                // 6. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ü–†–û–ì–†–ï–°–° (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞)
                if (fileSize > 0) {
                    int newPercent = (int) ((totalBytesRead * 100) / fileSize);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è
                    if (newPercent > percentComplete) {
                        percentComplete = newPercent;
                        System.out.printf("   ‚è≥ –ü—Ä–æ–≥—Ä–µ—Å—Å: %3d%% (%s / %s)\n",
                                percentComplete,
                                formatFileSize(totalBytesRead),
                                formatFileSize(fileSize));
                    }
                }
            }

            System.out.println();
            System.out.println("üìä –ò—Ç–æ–≥–æ —Å–∫–∞—á–∞–Ω–æ: " + formatFileSize(totalBytesRead));

        } finally {
            // 7. –ó–ê–ö–†–´–í–ê–ï–ú –°–û–ï–î–ò–ù–ï–ù–ò–ï
            connection.disconnect();
            System.out.println("üîí –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
        }
    }

    /**
     * –ü–†–ï–û–ë–†–ê–ó–£–ï–¢ –†–ê–ó–ú–ï–† –§–ê–ô–õ–ê –í –ß–ò–¢–ê–ï–ú–´–ô –§–û–†–ú–ê–¢
     * –ü—Ä–∏–º–µ—Ä: 1024 ‚Üí "1.0 KB"
     */
    private static String formatFileSize(long bytes) {
        if (bytes < 1024) {
            return bytes + " –±–∞–π—Ç";
        } else if (bytes < 1024 * 1024) {
            return String.format("%.1f KB", bytes / 1024.0);
        } else if (bytes < 1024 * 1024 * 1024) {
            return String.format("%.1f MB", bytes / (1024.0 * 1024.0));
        } else {
            return String.format("%.1f GB", bytes / (1024.0 * 1024.0 * 1024.0));
        }
    }
}
